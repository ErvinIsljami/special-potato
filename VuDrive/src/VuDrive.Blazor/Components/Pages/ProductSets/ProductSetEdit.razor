@page "/product-sets/edit/{Id:guid?}"
@attribute [Authorize]
@inject IProductSetAppService AppService
@inject ICarAppService CarAppService
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3>@(Id.HasValue ? "Edit Product Set" : "New Product Set")</h3>

<EditForm EditContext="@editContext" @onsubmit:preventDefault="true">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label class="form-label" for="name">Name <span class="text-danger">*</span></label>
        <InputText id="name" class="form-control" @bind-Value="Model.Name" maxlength="128" />
        <ValidationMessage For="() => Model.Name" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="desc">Description</label>
        <InputText id="desc" class="form-control" @bind-Value="Model.Description" maxlength="2048" />
        <ValidationMessage For="() => Model.Description" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="size">Size (inches) <span class="text-danger">*</span></label>
        <InputNumber id="size" class="form-control" TValue="decimal" @bind-Value="Model.SizeInInches" />
        <ValidationMessage For="() => Model.SizeInInches" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="look">Look variant</label>
        <InputText id="look" class="form-control" @bind-Value="Model.LookVariant" maxlength="64" />
        <ValidationMessage For="() => Model.LookVariant" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="color">Color</label>
        <InputText id="color" class="form-control" @bind-Value="Model.Color" maxlength="32" />
        <ValidationMessage For="() => Model.Color" />
    </div>

    <div class="form-check mb-2">
        <InputCheckbox id="cd" class="form-check-input" @bind-Value="Model.Cd" />
        <label class="form-check-label" for="cd">CD</label>
    </div>

    <div class="form-check mb-4">
        <InputCheckbox id="display" class="form-check-input" @bind-Value="Model.BuiltInDisplay" />
        <label class="form-check-label" for="display">Built-in Display</label>
    </div>

    <!-- Cars: search-first dropdown (no list before search) -->
    <div class="mb-2" @ref="dropdownContainer">
        <label class="form-label" for="carSearch">Search Cars (Mark or Model)</label>
        <div class="position-relative">
            <input id="carSearch"
                   class="form-control"
                   placeholder="Start typing e.g. Golf or Alfa…"
                   value="@CarQuery"
                   @oninput="OnSearchInput"
                   @onfocus="OnSearchFocus"
                   @onkeydown="HandleSearchKeyDown" />

            @if (ShowDropdown)
            {
                <div class="border rounded bg-white shadow-sm position-absolute w-100 mt-1"
                     style="z-index: 1050; max-height: 540px; overflow:auto;"
                     @onclick:stopPropagation="true">
                    @if (SearchResults.Count == 0)
                    {
                        <div class="p-2 text-muted">No matches.</div>
                    }
                    else
                    {
                        @foreach (var car in SearchResults)
                        {
                            var checkedNow = Model.CompatibleCarIds.Contains(car.Id);
                            <label class="d-flex align-items-start gap-2 p-2 border-bottom"
                                   style="cursor:pointer;"
                                   @onclick:stopPropagation="true">
                                <input type="checkbox"
                                       class="form-check-input mt-1"
                                       checked="@checkedNow"
                                       @onchange="(ChangeEventArgs e) => ToggleCar(car.Id, e.Value is bool b && b)"
                                       @onclick:stopPropagation="true" />
                                <div>
                                    <div><strong>@car.Mark</strong> @car.Model <small class="text-muted">(@car.SpecificationModel)</small></div>
                                    <div class="text-muted" style="font-size:.9rem;">@string.Join(", ", car.YearsBuilt ?? new())</div>
                                </div>
                            </label>
                        }
                    }
                    <div class="p-2 border-top bg-light">
                        <button type="button" class="btn btn-sm btn-primary" @onclick="CloseDropdown">Done</button>
                    </div>
                </div>
            }
        </div>
        <small class="text-muted">Type at least 2 characters. Press Escape or click Done to close. Results list is scrollable if long.</small>
    </div>

    <!-- Show chosen cars as compact badges -->
    @if (Model.CompatibleCarIds?.Count > 0 && SelectedCars.Any())
    {
        <div class="mb-3">
            <div class="d-flex flex-wrap gap-2">
                @foreach (var car in SelectedCars)
                {
                    <span class="badge text-bg-light border">
                        @car.Mark @car.Model
                        <button type="button"
                                class="btn-close btn-close-white ms-2"
                                style="filter: invert(1); opacity:.6;"
                                aria-label="Remove"
                                @onclick="() => ToggleCar(car.Id, false)">
                        </button>
                    </span>
                }
            </div>
        </div>
    }

    <div class="mt-4">
        <button type="button" class="btn btn-primary me-2" @onclick="Save">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="Back">Cancel</button>
    </div>

    <div class="mt-3">
        <Microsoft.AspNetCore.Components.Forms.ValidationSummary />
    </div>

</EditForm>

@code {
    [Parameter] public Guid? Id { get; set; }
    CreateUpdateProductSetDto Model = new();

    EditContext? editContext;
    ElementReference dropdownContainer;

    // Search state
    string CarQuery { get; set; } = string.Empty;
    List<CarDto> SearchResults { get; set; } = new();
    System.Threading.CancellationTokenSource? _searchCts;
    bool _isDropdownOpen = false;

    // Selected cars (for badges)
    List<CarDto> SelectedCars { get; set; } = new();

    bool ShowDropdown => _isDropdownOpen
        && !string.IsNullOrWhiteSpace(CarQuery)
        && CarQuery.Trim().Length >= 2
        && SearchResults != null;

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            var dto = await AppService.GetAsync(Id.Value);
            Model = new()
                {
                    Name = dto.Name,
                    Description = dto.Description,
                    SizeInInches = dto.SizeInInches,
                    LookVariant = dto.LookVariant,
                    Color = dto.Color,
                    Cd = dto.Cd,
                    BuiltInDisplay = dto.BuiltInDisplay,
                    CompatibleCarIds = dto.CompatibleCarIds ?? new()
                };

            // Preload minimal info for badges (best-effort)
            await RefreshSelectedCars();
        }

        editContext = new EditContext(Model);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("eval", @"
                document.addEventListener('click', function(e) {
                    const dropdown = document.querySelector('[style*=""z-index: 1050""]');
                    const searchInput = document.getElementById('carSearch');
                    if (dropdown && !dropdown.contains(e.target) && e.target !== searchInput) {
                        DotNet.invokeMethodAsync('YourAssemblyName', 'CloseDropdownFromJS');
                    }
                });
            ");
        }
    }

    void OnSearchFocus()
    {
        if (!string.IsNullOrWhiteSpace(CarQuery) && CarQuery.Trim().Length >= 2)
        {
            _isDropdownOpen = true;
        }
    }

    void HandleSearchKeyDown(Microsoft.AspNetCore.Components.Web.KeyboardEventArgs e)
    {
        if (string.Equals(e.Key, "Escape", StringComparison.OrdinalIgnoreCase))
        {
            CloseDropdown();
        }
        else if (string.Equals(e.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            // Prevent accidental form submit
        }
    }

    async Task OnSearchInput(ChangeEventArgs e)
    {
        CarQuery = e.Value?.ToString() ?? string.Empty;
        _isDropdownOpen = true;

        // Debounce ~250ms
        _searchCts?.Cancel();
        _searchCts = new();
        try
        {
            await Task.Delay(250, _searchCts.Token);
        }
        catch (TaskCanceledException)
        {
            return;
        }

        await ExecuteSearch();
    }

    async Task ExecuteSearch()
    {
        SearchResults = new();

        var term = (CarQuery ?? string.Empty).Trim();
        if (term.Length < 2)
        {
            StateHasChanged();
            return;
        }

        // We need OR (Mark OR Model). The list API applies filters with AND,
        // so call twice and union by Id.
        var byMark = await CarAppService.GetListAsync(new CarsListInput
            {
                Mark = term,
                MaxResultCount = 200
            });

        var byModel = await CarAppService.GetListAsync(new CarsListInput
            {
                Model = term,
                MaxResultCount = 200
            });

        SearchResults = byMark.Items
            .Concat(byModel.Items)
            .GroupBy(x => x.Id)
            .Select(g => g.First())
            .OrderBy(x => x.Mark)
            .ThenBy(x => x.Model)
            .ToList();

        StateHasChanged();
    }

    void CloseDropdown()
    {
        _isDropdownOpen = false;
        StateHasChanged();
    }

    void ToggleCar(Guid carId, bool add)
    {
        if (add)
        {
            if (!Model.CompatibleCarIds.Contains(carId))
                Model.CompatibleCarIds.Add(carId);
        }
        else
        {
            Model.CompatibleCarIds.Remove(carId);
        }

        // Keep SelectedCars badges in sync
        _ = RefreshSelectedCars();
    }

    async Task RefreshSelectedCars()
    {
        if (Model.CompatibleCarIds is null || Model.CompatibleCarIds.Count == 0)
        {
            SelectedCars = new();
            StateHasChanged();
            return;
        }

        // Fetch by Ids through the list call (best-effort) or reuse last search result
        // Here we try to reuse SearchResults first
        var map = SearchResults.ToDictionary(x => x.Id, x => x);
        var list = new List<CarDto>();

        foreach (var id in Model.CompatibleCarIds.Distinct())
        {
            if (map.TryGetValue(id, out var found))
            {
                list.Add(found);
            }
            else
            {
                // fallback: fetch single item
                try
                {
                    var single = await CarAppService.GetAsync(id);
                    list.Add(single);
                }
                catch
                {
                    // ignore if not found/permission, etc.
                }
            }
        }

        SelectedCars = list
            .OrderBy(x => x.Mark)
            .ThenBy(x => x.Model)
            .ToList();

        StateHasChanged();
    }

    async Task Save()
    {
        if (editContext is not null && !editContext.Validate())
            return;

        if (Id.HasValue) await AppService.UpdateAsync(Id.Value, Model);
        else await AppService.CreateAsync(Model);

        Back();
    }

    void Back() => Nav.NavigateTo("/product-sets");
}